<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testcases Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-3xl font-bold mb-6">Testcases</h1>

  <!-- Tombol +NEW TESTCASE -->
  <button id="openModalBtn" class="bg-blue-100 text-blue-800 px-4 py-2 rounded mb-4 hover:bg-blue-200 transition">
    + NEW TESTCASE
  </button>
<!-- Bulk Add Testcases -->
<div class="w-full max-w-5xl mb-4 p-4 bg-gray-100 rounded shadow">
  <h2 class="text-lg font-bold mb-2">Bulk Add Testcases (Paste multiple rows)</h2>
  <p class="text-sm text-gray-600 mb-2">Format: Title | Description | Status (PASSED/FAILED/BLOCKED)</p>
  <textarea id="bulkInput" rows="5" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="Example:\nLogin valid | User bisa login dengan credential valid | PASSED"></textarea>
  <div class="text-right mt-2">
    <button id="bulkAddBtn" class="bg-purple-100 text-purple-800 px-4 py-2 rounded hover:bg-purple-200 transition">Add Testcases</button>
  </div>
</div>



  <!-- Table Testcases -->
  <div class="w-full max-w-5xl overflow-x-auto">
    <table class="min-w-full border border-gray-200 bg-white rounded shadow">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="px-4 py-2 border-b">ID</th>
          <th class="px-4 py-2 border-b">Title</th>
          <th class="px-4 py-2 border-b">Description</th>
          <th class="px-4 py-2 border-b">Status</th>
          <th class="px-4 py-2 border-b">Actions</th>
        </tr>
      </thead>
      <tbody id="testcaseTableBody">
        <!-- Row data akan dimuat lewat JS -->
      </tbody>
    </table>
  </div>

  <!-- Modal Form (Create/Edit Testcase) -->
  <div id="testcaseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg w-full max-w-lg p-6 shadow-lg relative">
      <button id="closeModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">&times;</button>
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">Create Testcase</h2>
      <form id="testcaseForm" class="space-y-4">
        <input type="hidden" id="testcaseId">
        <div>
          <label for="title" class="block text-gray-700 font-medium mb-1">Title</label>
          <input type="text" id="title" name="title" required
                 class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
        </div>
        <div>
          <label for="description" class="block text-gray-700 font-medium mb-1">Description</label>
          <textarea id="description" name="description" rows="4" required
                    class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"></textarea>
        </div>
        <div>
          <label for="status" class="block text-gray-700 font-medium mb-1">Status</label>
          <select id="status" name="status" required
                  class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
            <option value="PASSED">PASSED</option>
            <option value="FAILED">FAILED</option>
            <option value="BLOCKED">BLOCKED</option>
          </select>
        </div>
        <div class="text-right">
          <button type="submit" class="bg-green-100 text-green-800 px-4 py-2 rounded hover:bg-green-200 transition">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
const modal = document.getElementById('testcaseModal');
const openBtn = document.getElementById('openModalBtn');
const closeBtn = document.getElementById('closeModalBtn');
const form = document.getElementById('testcaseForm');
const tableBody = document.getElementById('testcaseTableBody');
const modalTitle = document.getElementById('modalTitle');
const testcaseIdInput = document.getElementById('testcaseId');

let testcases = [];

// Open modal for create
openBtn.addEventListener('click', () => {
  modalTitle.textContent = 'Create Testcase';
  testcaseIdInput.value = '';
  form.reset();
  modal.classList.remove('hidden');
});

// Close modal
closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

// Load testcases from backend
async function loadTestcases() {
  try {
    const res = await fetch('/'); // sesuai route getTestcases
    testcases = await res.json();
    renderTable();
  } catch (err) {
    console.error(err);
    alert('Failed to load testcases');
  }
}

// Render table rows
function renderTable() {
  tableBody.innerHTML = '';
  testcases.forEach(tc => {
    const statusColor = tc.status === 'PASSED' ? 'green' : tc.status === 'FAILED' ? 'red' : 'gray';
    const row = document.createElement('tr');
    row.classList.add('hover:bg-gray-50');
    row.innerHTML = `
      <td class="px-4 py-2 border-b text-gray-700">${tc.id}</td>
      <td class="px-4 py-2 border-b text-gray-700">${tc.title}</td>
      <td class="px-4 py-2 border-b text-gray-700">${tc.description}</td>
      <td class="px-4 py-2 border-b">
        <span class="bg-${statusColor}-100 text-${statusColor}-800 px-2 py-1 rounded">${tc.status}</span>
      </td>
      <td class="px-4 py-2 border-b space-x-2">
        <button class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded hover:bg-yellow-200 transition editBtn">EDIT</button>
        <button class="bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200 transition deleteBtn">DELETE</button>
      </td>
    `;
    // Edit
    row.querySelector('.editBtn').addEventListener('click', () => {
      modalTitle.textContent = 'Edit Testcase';
      testcaseIdInput.value = tc.id;
      form.title.value = tc.title;
      form.description.value = tc.description;
      form.status.value = tc.status;
      modal.classList.remove('hidden');
    });
    // Delete
    row.querySelector('.deleteBtn').addEventListener('click', async () => {
      if (!confirm('Are you sure to delete this testcase?')) return;
      try {
        await fetch(`/${tc.id}`, { method: 'DELETE' });
        testcases = testcases.filter(t => t.id !== tc.id);
        renderTable();
      } catch (err) {
        console.error(err);
        alert('Failed to delete testcase');
      }
    });
    tableBody.appendChild(row);
  });
}

// Submit form for create/edit
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = testcaseIdInput.value;
  const payload = {
    title: form.title.value,
    description: form.description.value,
    status: form.status.value
  };
  try {
    let res, data;
    if (id) {
      res = await fetch(`/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      data = await res.json();
      const index = testcases.findIndex(t => t.id == id);
      testcases[index] = data;
    } else {
      res = await fetch('/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      data = await res.json();
      testcases.unshift(data);
    }
    renderTable();
    form.reset();
    modal.classList.add('hidden');
  } catch (err) {
    console.error(err);
    alert('Failed to save testcase');
  }
});

// Load table on page load
loadTestcases();
</script>
</body>
</html>
